name: Build and Push Docker Image

on:
  pull_request:
    types: [closed]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v1

    - name: SonarCloud Scan
      uses: sonarsource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

    - name: Build Docker image
      run: |
        docker build -t valerykhirin/github-image-push-actions:latest .
        echo "Image built!"

    - name: Run Snyk to check Docker image for vulnerabilities
      continue-on-error: true
      uses: snyk/actions/docker@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        image: valerykhirin/github-image-push-actions:latest
        args: --severity-threshold=high

    - name: Comment on pull request with scan results
      uses: peter-evans/create-or-update-pull-request-comment@v2
      if: always()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        body: |
          {{#if vulnerabilityCount}}
          **Snyk scan found vulnerabilities:**

          {{vulnerabilityCount}} vulnerability{{#if vulnerabilityCount}}s{{/if}} found

          For more details, see the [Snyk report]({{reportUrl}}).
          {{else}}
          No vulnerabilities found in the Snyk scan.
          {{/if}}

    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: "${{ secrets.DOCKERHUB_USERNAME }}"
        password: "${{ secrets.DOCKERHUB_TOKEN }}"

    - name: Push Docker image
      run: |
        docker push valerykhirin/github-image-push-actions:latest
        echo "Image is pushed to docker hub with the tag latest"
