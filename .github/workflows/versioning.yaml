name: Versioning Workflow
on:
  pull_request:
    types: [closed]
jobs:
  update_version:
    permissions: write-all
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Check branch name and increment version
        run: |
          # Get the branch name from the event payload
          BRANCH_NAME=${{ github.event.pull_request.head.ref }}
          echo BRANCH_NAME

          # Set the initial version number
          CURRENT_VERSION="0.0.0"

          # Increment the version number based on the branch name
          if [[ $BRANCH_NAME == "patch"* ]]; then
            NEW_VERSION=$(echo $CURRENT_VERSION | awk -F. -v OFS=. '{$3++; print}')
          elif [[ $BRANCH_NAME == "feature"* ]]; then
            NEW_VERSION=$(echo $CURRENT_VERSION | awk -F. -v OFS=. '{$2++; print}')
          elif [[ $BRANCH_NAME == "release"* ]]; then
            NEW_VERSION=$(echo $CURRENT_VERSION | awk -F. -v OFS=. '{$1++; print}')
          fi

          # # Set the new version number as an environment variable
          # echo "::set-env name=NEW_VERSION::$NEW_VERSION"
      
      - name: Update version number
        run: |
          awk -v old="$CURRENT_VERSION" -v new="$NEW_VERSION" '{gsub(old,new)}1' VERSION > tmpfile && mv tmpfile VERSION

      - name: Create tag
        run: |
          git config --global user.name "ValeryKhirin"
          git config --global user.email "valeryk@bynet.co.il"
          TAG=$(cat VERSION)
          git tag "$TAG"
          git push origin "$TAG"
#